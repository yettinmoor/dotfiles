#!/bin/sh
# dwm statusbar script, somewhat inspired by i3blocks.
# Declare a function starting with "get_" to add a block.
# Call dwmbar init to set everything up and dwmbar [function name] to update that function.
# E.g. "dwmbar rss" will update the RSS block WITHOUT calling all other functions, like the slow pacman -Qu command.
#
# TODO: add more convenient coloring if I can figure out dwm pango

sep="  |  "
rp="   " # right padding

get_music() {
	mpc -f "%artist% - %title%" | sed "/^volume/d" | tac |
		sed "
			s/\\[\(.*\)\\].*/\1 /;
			s/paused/⏸/;
			s/playing/▶/;" | tr -d '\n'
}

get_torrents() {
	tor=$( { transmission-remote -l 2>/dev/null || exit 1; } | sed '1d;$d' | \
		sed -E "
			s/.*(100%|Seeding).*/@/;
			s/.*%.*/v/;
			s/.*(Paused|Waiting).*/\./" | \
				sort | uniq -c | awk '{print $2 $1}' | tr '\n' ' ' | sed "s/ $//" )
	[ -n "$tor" ] && printf "%s" "$tor"
}

get_weather() {
	sed '13q;d' /tmp/weatherreport | \
		grep -o "m\\([+-]\\)*[0-9]\\+" | \
		sort -n -t 'm' -k 2n | \
		sed -n '1p;$p' | \
		tr '\n|m|+' ' ' | \
		awk '{print "" $2 "° " $1 "°"}'
}

get_packages() {
	pacman -Qu | grep -v "ignored" | wc -l | sed "/^0/d; s/^[0-9]/? &/"
}

get_rss() {
	[ -s /tmp/newsupdate ] \
		&& cat /tmp/newsupdate \
		|| newsboat -x print-unread | cut -d' ' -f1 | sed "/^0/d; s/^[0-9]/\! &/"
}

get_volume() {
	amixer get Master | grep -q "off" \
		&& echo "Muted" \
		|| amixer -M get Master | grep -o "[0-9]*%"
}

get_date() {
	echo "$( date '+%a %b/%d (%V)' )"
}

get_time() {
	date +%R
}

case $1 in
	"init")
		rm -f /tmp/dwmbar
		for f in $( grep -o "^get_[a-z]*" $0 ); do
			echo "${f#get_}:$( $f )" >> /tmp/dwmbar
		done ;;
	*)
		command -v "get_$1" >/dev/null 2>&1 || exit 1
		sed -i "s|^\($1:\).*|\1$( get_$1 | tr -d '\n' )|" /tmp/dwmbar ;;
esac

xsetroot -name "$( sed "s/^[a-z]*://g; /^$/d; 1,$ a$sep" /tmp/dwmbar | tr -d '\n' | sed "s/$sep$/$rp/" )"
