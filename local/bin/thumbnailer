#!/usr/bin/env sh
# Creates a nice 3x3 collage thumbnail from a video file.

DEFAULT_QUAL=7
DEFAULT_SIZE=300

usage() {
    exit_code=$1
    cat << EOF
Usage: thumbnailer [options] infile
  -o [outfile]  Set outfile path (default: [infile].jpg)
  -s [size]     Set size of images (default: $DEFAULT_SIZE)
  -q [quality]  Set quality (default: $DEFAULT_QUAL)
  -h            Print usage
EOF
    exit $exit_code;
}

while getopts :ho:q:s: o; do
    case "$o" in
        o) outfile=$OPTARG ;;
        q) qual=$OPTARG ;;
        s) size=$OPTARG ;;
        h) usage 0 ;;
        ?) usage 1 ;;
    esac
done
shift $((OPTIND-1))

infile="$1"
outfile="${outfile:-${infile}.jpg}"

[ -z "$infile" ] && usage 1

seq 10 10 90 | xargs -P 0 -I {} ffmpegthumbnailer -i "$infile" -o "${outfile}_{}" -s ${size:-$DEFAULT_SIZE} -q ${qual:-$DEFAULT_QUAL} -t "{}%"

montage -geometry +0+0 $(seq 10 10 90 | awk 'ORS=" " {print "'$outfile'_" $1}') "$outfile"

seq 10 10 90 | xargs -P 0 -I {} rm "${outfile}_{}"
