#!/usr/bin/env sh

# shellcheck disable=SC2016
usage() {
    echo 'dl [-bv] <url>'
    echo 'download manager.'
    echo 'spawns `dirpick` for destination selection.'
    echo 'options:'
    echo ' -b     | rename file according to its SHA256 sum (see `store`).'
    echo ' -v     | use yt-dlp instead of curl.'
    echo ' -u url | download `url` instead of $QUTE_[HINT_]URL.'
    exit "$1"
}

while getopts bvh o; do
    case "$o" in
        b) BASE64=1 ;;
        v) YTDL=1 ;;
        h) usage 0 ;;
        *) usage 1 ;;
    esac
done

shift $((OPTIND - 1))

url="$1"
[ -z "$url" ] && usage 1

file="$(basename "$url")"
dir="$(dirpick)"

[ -z "$dir" ] && exit

mkdir -p "$dir"
cd "$dir" || exit 1

if [ -n "$YTDL" ]; then
    echo "dl: downloading $url (ytdl)"
    file="$(yt-dlp --get-filename "$url")"
    yt-dlp "$url"
else
    echo "dl: downloading $url"
    curl -LO "$url"
fi

if [ -n "$BASE64" ]; then
    file=$(store -p -t "$dir" "$file")
fi

notify-send qutedl \
    "$(realpath "$file" | sed "s:^$HOME:~:")" \
    -i "$(realpath "$file")"
