#!/usr/bin/env sh

# shellcheck disable=SC2016
usage() {
    echo 'dl [-vs] <url>'
    echo 'download manager.'
    echo 'options:'
    echo ' -v | use yt-dlp instead of curl.'
    echo ' -s | invoke `store` on downloaded file.'
    exit "$1"
}

while getopts svh o; do
    case "$o" in
        s) STORE=1 ;;
        v) YTDL=1 ;;
        h) usage 0 ;;
        *) usage 1 ;;
    esac
done

shift $((OPTIND - 1))

url="$1"
[ -z "$url" ] && usage 1

file="$(basename "$url")"

cd ~/dl || exit 1

set -e

if [ -n "$STORE" ]; then
    dir=$(dirpick)
    [ -z "$dir" ] && exit
fi

id="$(awk "BEGIN { srand($(date +%N)); print int(65535 * rand()); }")"

if [ -n "$YTDL" ]; then
    dunstify -r "$id" qdl "downloading $url (ytdl)"
    file="$(yt-dlp --get-filename "$url")"
    yt-dlp "$url"
else
    dunstify -r "$id" qdl "downloading $url"
    curl -LO "$url"
fi

if [ -n "$STORE" ]; then
    file=$(store -t "$dir" -p "$file")
fi

dunstify -r "$id" qdl \
    "$(realpath "$file" | sed "s:^$HOME:~:")" \
    -i "$(realpath "$file")"
