#!/usr/bin/env sh
# All-in-one file compiler.

file="$(readlink -f "$1")"
dir="$(dirname "$file")"
base="${file%.*}"

[ -z "$file" ] && exit 1

head -n 1 "$file" | rg -o 'compiler: (.+)' -r '$1' | {
    read -r cmd
    [ -n "$cmd" ] && {
        $cmd "$file"
        exit
    }
}

if [ -f .compiler ]; then
    sh .compiler
    exit
fi

if [ -f Makefile ]; then
    make
    exit
fi

case "${file#*.}" in
    # Shell
    sh) sh "$file" ;;

    # Programming
    c)   cc "$file" -o "$base" && "$base" ;;
    cpp) g++ "$file" -o "$base" && "$base" ;;
    cs)  mcs "$file" ;;
    go)  go run "$file" ;;
    hs)  runhaskell "$file" ;;
    js)  node "$file" ;;
    nim) if fd -q -e nimble; then nimble build -r; else nim r --verbosity:0 "$file"; fi ;;
    pl)  perl "$file" ;;
    py)  python "$file" ;;
    rkt) racket "$file" ;;
    rs)  cargo run "$file" ;;
    scm) chicken-csi -q "$file" ;;
    ts)  deno run --allow-read "$file" ;;
    zig) if [ -f "build.zig" ]; then zig build run; else zig run "$(grep -q "cImport" "$file" && echo "-lc")" "$file"; fi ;;

    # Document formatting
    tex) xelatex --output-directory="$dir" "$base" ;;
    md)  pandoc "$file" --pdf-engine=xelatex --template=template -o "$base".pdf ;;

    # sent
    sent) setsid sent "$file" & ;;

    # Shebang
    *) sed -n '1{/^#!/s///p}' "$file" | xargs -r -I {} "$file" ;;
esac
