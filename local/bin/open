#!/usr/bin/env sh

browser() { fzf; }
opener="$EDITOR \"{}\""

while getopts :d o; do
    case "$o" in
        d)
            if [ -n "$DISPLAY" ]; then
                browser() { dmenu -i -p "open $(pwd)" -theme-str 'window {width: 80%;}'; }
                opener='setsid xdg-open "{}" &'
            fi
            ;;
        ?)
            echo 'usage: open [-d] dir [fd flags]'
            exit 1
            ;;
    esac
done

shift $((OPTIND - 1))

if [ -n "$1" ]; then
    cd "$1" || exit 1
    shift
fi

exts='\.(jpe?g|png|gif|mkv|mp4|m4v|avi|webm|mp3|pdf|djvu|epub|txt|md|sent|svg|html|cbr|cbz)$'

fd --strip-cwd-prefix -t f "$exts" "$@" \
    | browser \
    | xargs -r -I {} sh -c "$opener"
