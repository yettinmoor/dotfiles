#!/usr/bin/env sh

# shellcheck disable=SC2016
usage() {
    echo 'launch [-dexh] <file|cmd>'
    echo
    echo 'a general URI opener.'
    echo 'wraps opener in `setsid`.'
    echo
    echo 'options:'
    echo '  -d | wrap with `devour` if available.'
    echo '  -e | don'\''t wrap $EDITOR.'
    echo '  -x | interpret args as shell command.'
    echo '  -h | print help and exit.'
    exit "$1"
}

wrap() { setsid "$@" > /dev/null 2>&1 & }

while getopts dexh o; do
    case $o in
        d)
            [ -n "$DISPLAY" ] && wrap() { devour "$@"; }
            ;;
        e)
            LAUNCH_EDITOR_INLINE=1
            ;;
        x)
            LITERAL=1
            ;;
        h)
            usage 0
            ;;
        *)
            usage 1
            ;;
    esac
done

shift $((OPTIND - 1))

[ $# -eq 0 ] && {
    usage 1
}

[ -n "$LITERAL" ] && {
    wrap "$@"
    exit
}

for file in "$@"; do
    case "$file" in
        http://* | https://*)
            case "$file" in
                *mkv | \
                    *webm | \
                    *mov | \
                    *mp4 | \
                    *youtube.com* | \
                    *youtu.be* | \
                    *bitchute.com* | \
                    *twitch.tv* | \
                    *nebula.app*)
                    wrap mpv "$file"
                    ;;
                *png | *jpg | *jpeg | *gif)
                    curl -sLO "$file" && wrap sxiv -a "$(basename "$file")"
                    ;;
                *mp3 | *flac | *opus | *mp3?source*)
                    cd "$HOME/dl" || exit 1
                    wrap tsp curl -LO "$file"
                    ;;
                *)
                    wrap "$BROWSER" "$file"
                    ;;
            esac
            ;;
        magnet:*)
            tor "$file"
            ;;
        *)
            file="$(readlink -f "$file")"
            [ -f "$file" ] || {
                echo "error: non-existent file: $1"
                exit 1
            }
            case "$(file --mime-type "$file" -bL)" in
                video/* | audio/*)
                    wrap mpv "$file"
                    ;;
                application/pdf | \
                    application/postscript | \
                    application/epub+zip | \
                    application/x-rar | \
                    image/vnd.djvu)
                    wrap zathura "$file"
                    ;;
                image/svg+xml)
                    wrap inkview "$1"
                    ;;
                image/*)
                    wrap imgopen "$1"
                    ;;
                application/x-bittorrent)
                    wrap tor "$file"
                    ;;
                text/html)
                    wrap "$BROWSER" "$file"
                    ;;
                *)
                    if [ -n "$LAUNCH_EDITOR_INLINE" ]; then
                        "$EDITOR" "$file"
                    else
                        wrap "$TERMINAL" -e "$EDITOR" "$file"
                    fi
                    ;;
            esac
            ;;
    esac
done
