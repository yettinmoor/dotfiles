#!/usr/bin/env sh

#shellcheck disable=2016
usage() {
    echo 'todo  -- task organizer & daily optimizer'
    echo ''
    echo 'usage:'
    echo '  todo list    [search]  | (default action) list all items matching `search`'
    echo '  todo add     [dir]     | add new item in `dir`'
    echo '  todo cat     [search]  | describe all items matching `search`'
    echo '  todo edit    [search]* | edit description of item matching `search`'
    echo '  todo title   [search]* | edit title of item matching `search`'
    echo '  todo <state> [search]* | set state of item matching `search`'
    echo '                         |     state := (todo|open|hold|done|ever)'
    echo '  todo rm      [search]* | remove item matching `search`'
    echo '  todo dir     [search]* | print directory of task matching `search`'
    echo '                         |     add the following to your shell rc:'
    echo '                         |     tcd() { cd "$(todo dir "$1")"; }'
    echo '                         |'
    echo '  todo help              | show this help'
    echo ''
    echo '[search] strings will match:'
    echo '  - task IDs'
    echo '  - task names'
    echo '  - if -a flag is used, any file within a task'
    echo '*: must manually select from multiple results.'
    echo ''
    exit "$1"
}

search() {
    if [ "$1" = '-a' ]; then
        search_all=1
        shift
    fi

    term="$*"

    if [ -z "$1" ]; then
        fd --strip-cwd-prefix -t d "[0-9a-f]{6}$" -x echo {}
        return
    fi

    for item in $(fd --strip-cwd-prefix -t d "[0-9a-f]{6}$"); do
        cd "$TODO_DIR/$item" || exit 1

        # match filename
        case "$item" in
            *"$term"*)
                found=1
                echo "$item" | sed 's:/$::'
                continue
                ;;
        esac

        # match filename
        case "$(cat title)" in
            *"$term"*)
                found=1
                echo "$item" | sed 's:/$::'
                continue
                ;;
        esac

        # match any file
        if [ -n "$search_all" ] && { fd -q "$term" || rg -qi "$term"; }; then
            found=1
            echo "$item" | sed 's:/$::'
            continue
        fi
    done

    cd "$TODO_DIR" || exit 1

    if [ -z "$found" ]; then
        echo no tasks found for search string \""$term"\" > /dev/stderr
    fi
}

search_select() {
    desc="$1"
    shift

    items="$(search "$*")"
    lines="$(echo "$items" | wc -l)"

    if [ "$lines" -eq 1 ]; then
        item="$items"
    else
        echo "$items" | while read -r item; do
            describe "$item"
        done | nl >&2
        printf 'select task to %s) ' "$desc" > /dev/stderr
        read -r sel
        if [ -n "${sel##*[!0-9]*}" ] \
                && [ "$sel" -ge 1 ] \
                && [ "$sel" -le "$lines" ]; then
            item="$(echo "$items" | sed "$sel!d")"
        else
            echo invalid selection: "$sel" >&2
            exit 1
        fi
    fi

    echo "$item"
}

describe() {
    item="$1"
    state="$(cat "$item/state" 2> /dev/null)"
    case "$state" in
        todo) statefmt=$(color wht %s) ;;
        open) statefmt=$(color -b yel %s) ;;
        hold) statefmt=$(color red %s) ;;
        ever) statefmt=$(color prp %s) ;;
        done) statefmt=$(color grn %s) ;;
    esac
    printf "$(color yel %s/)%s | $statefmt | $(color blu %s)\n" \
        "$(dirname "$item")" \
        "$(basename "$item")" \
        "$state" \
        "$(cat "$item/title")"
}

print_path_and_title() {
    item="$1"
    printf "$(color yel)%s/$(color clr)%s $(color blu)%s$(color clr)\n" \
        "$(dirname "$item")" \
        "$(basename "$item")" \
        "$(cat "$item/title")"
}

TODO_DIR="${TODO_DIR:-$HOME/docs/todo}"
cd "$TODO_DIR" || exit 1

cmd="$1"
[ -n "$cmd" ] && shift

case "$cmd" in
    '' | l | list)
        search "$@" \
            | while read -r path; do describe "$path" & done \
            | sort -b -t '|' -k 2r,2 -k 1,1 \
            | tabulate -s '\|' -f plain
        ;;

    a | add)
        # generate name
        dir="${1:-.}"
        while [ -z "$item" ] || [ -f "$item" ]; do
            item="$dir/$(hexdump -vn3 -e'"%06x" 1 "\n"' /dev/urandom)"
        done

        # edit tmp file
        tmpfile="$(mktemp)"
        $EDITOR "$tmpfile" -c 'set ft=markdown' || exit 1
        if [ ! -s "$tmpfile" ] || [ "$(wc -c < "$tmpfile")" -le 1 ]; then
            echo aborting new todo item.
            exit
        fi

        mkdir -pv "$item"
        head -n 1 "$tmpfile" > "$item/title"
        sed -e '1d' -e '/./,$!d' "$tmpfile" > "$item/desc.md"

        echo 'todo' > "$item/state"

        rm "$tmpfile"
        ;;

    c | cat)
        search "$@" | while read -r item; do
            [ -n "$not_first" ] && echo

            {
                cat "$item/desc.md"

                cd "$item" || exit 1
                files="$(fd -t f --exclude title --exclude state --exclude desc.md)"
                if [ -n "$files" ]; then
                    echo
                    color yel 'files:\n'
                    color wht "$files"
                fi
            } | bat \
                --file-name="$(describe "$item")" \
                -f \
                --style=grid,header \
                --paging=never \
                --terminal-width="$(tput cols)"

            cd "$TODO_DIR" || exit 1

            not_first=1
        done | bat -p
        ;;

    e | edit)
        item=$(search_select edit "$@")
        [ -z "$item" ] && exit 1
        $EDITOR "$item/desc.md"
        echo "edited $(print_path_and_title "$item")"
        ;;

    t | title)
        item=$(search_select retitle "$@")
        [ -z "$item" ] && exit 1
        $EDITOR "$item/title"
        echo "retitled $(print_path_and_title "$item")"
        ;;

    todo | open | hold | done | ever)
        state="$cmd"
        item=$(search_select "set to '$state'" "$@")
        [ -z "$item" ] && exit 1
        echo "$state" > "$item/state"
        echo "set $(print_path_and_title "$item") to '$state'"
        ;;

    r | rm)
        item=$(search_select remove "$@")
        printf 'remove %s (%s)? [y/N] ' "$item" "$(cat "$item/title")"
        read -r ans
        if echo "$ans" | grep -qiE '^y(es)?$'; then
            rm -r "${TODO_DIR:-.}/$item"
            echo "removed $(print_path_and_title "$item")"
        fi
        ;;

    dir)
        [ -n "$1" ] && item=$(search_select 'cd to' "$@")
        echo "$TODO_DIR/$item"
        ;;

    h | help)
        usage 0
        ;;

    *)
        usage 1
        ;;
esac
