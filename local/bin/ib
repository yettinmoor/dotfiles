#!/usr/bin/env sh

engines=$(
    cat <<- EOF
1 ðŸ‡¬ðŸ‡§ xkb:us:altgr-intl:eng Aa
2 ðŸ‡¯ðŸ‡µ anthy æ–‡
3 ðŸ‡¬ðŸ‡· xkb:gr::ell AÎ©
4 ðŸ‡·ðŸ‡º xkb:ru::rus ÐÐ¯
? ðŸŽ¹ help
EOF
)

DATA_DIR="$XDG_DATA_HOME/ib"
DUNST_ID=9191

notify() { dunstify -r $DUNST_ID "ib" "$@"; }

icon() {
    echo "$engines" | grep "$(ibus engine)" | cut -d ' ' -f4
}

show() {
    if running; then
        notify "$(icon)"
    else
        dunstify -C $DUNST_ID
    fi
}

running() {
    pgrep ibus > /dev/null
}

case "$1" in
    power)
        if running; then
            ibus exit
            notify stopped.
        else
            ibus-daemon -drx
            notify started.
        fi
        ;;

    toggle)
        running || exit 1
        choice="$(echo "$engines" | cut -d ' ' -f1-2 | dmenu -p 'Keyboard layout' -L "$(echo "$engines" | wc -l)" -width 10)" || exit
        engine=$(echo "$engines" | grep "${choice:?}" | cut -d ' ' -f3)
        if [ "$engine" = "help" ]; then
            kbimg="$DATA_DIR/$(icon).png"
            if [ -f "$kbimg" ]; then
                sxiv "$kbimg"
            else
                notify "no keyboard image found for '$(icon)'"
            fi
        else
            ibus engine "$engine"
            show
        fi
        ;;

    *)
        exit
        ;;

esac 2> /dev/null
