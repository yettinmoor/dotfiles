#!/usr/bin/env sh

engines=$(
    cat <<- EOF
1 ðŸ‡¯ðŸ‡µ anthy æ–‡
2 ðŸ‡¬ðŸ‡· fcitx-keyboard-gr AÎ©
? ðŸŽ¹ help
EOF
)

DATA_DIR="$XDG_DATA_HOME/ib"
DUNST_ID=9191

notify() { dunstify -r $DUNST_ID "ib" "$@"; }

icon() {
    echo "$engines" | grep "$(ibus engine)" | cut -d ' ' -f4
}

case "$1" in
    toggle)
        case "$(fcitx-remote)" in
            1) fcitx-remote -t ;;
            2) fcitx-remote -T ;;
            *) ;;
        esac
        ;;

    select)
        echo "$engines" \
            | cut -d ' ' -f1-2 \
            | dmenu -p 'Keyboard layout' -L "$(echo "$engines" | wc -l)" -width 10 \
            | {
                read -r choice
                choice=$(echo "$engines" | grep "${choice:?}")
                engine=$(echo "$choice" | cut -d ' ' -f3)
                if [ "$engine" = "help" ]; then
                    kbimg="$DATA_DIR/$(icon).png"
                    if [ -f "$kbimg" ]; then
                        sxiv "$kbimg"
                    else
                        notify "no keyboard image found for '$(icon)'"
                    fi
                else
                    fcitx-remote -s "$engine"
                fi
            }
        ;;

    *)
        exit
        ;;

esac 2> /dev/null
