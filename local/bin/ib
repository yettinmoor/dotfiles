#!/usr/bin/env sh

# This script is buggy as hell and I want to kill myself

engines=$(cat <<- EOF
1 US xkb:en::us Aa
2 JA anthy 文
3 GR xkb:gr::ell AΩ
EOF
)

show() {
    icon=$(echo "$engines" | grep $(ibus engine) | cut -d ' ' -f4)
    dunstify -r 9191 -u critical "$icon"
    dwmbar ib "$icon"
}

is_running() {
    pgrep ibus >/dev/null
}

case "$1" in
    power)
        if is_running; then ibus exit; else ibus-daemon -drx; fi
        sleep .5 ;;
    toggle)
        is_running || exit 1
        choice=$(echo "$engines" | cut -d ' ' -f1-2 | rofi -dmenu -p 'Engine' -L $(echo "$engines" | wc -l) -width 10)
        engine=$(echo "$engines" | grep "${choice:?}" | cut -d ' ' -f3)
        ibus engine $engine ;;
esac 2>/dev/null

show
